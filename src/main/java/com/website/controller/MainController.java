package com.website.controller;

import com.website.services.*;
import com.website.entities.*;
import com.website.entities.Person;
import org.bson.BsonBinarySubType;
import org.bson.types.Binary;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.parameters.P;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.ui.ModelMap;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import javax.servlet.http.HttpServletRequest;
import java.io.IOException;
import java.security.Principal;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.*;
import java.util.stream.Collectors;

@Controller    // This means that this class is a Controller
public class MainController {
    @Autowired // This means to get the bean called userRepository
    // Which is auto-generated by Spring, we will use it to handle the data
    private PersonService personService;

    @Autowired
    private SkillService skillService;

    @Autowired
    private CompanyService companyService;

    @Autowired
    private JobService jobService;

    @GetMapping("/home")
    public String getHome() {
        return "home";
    }

    @GetMapping("/profilePage")
    public String getProfilePage(ModelMap map, Principal principal, String person)
    {
        Person currentUser = null;
        if(person==null)
        {
            String email = principal.getName();
            currentUser = personService.findByEmail(email);
        }
        else
        {
            currentUser = personService.findById(person);
        }

        if(currentUser.getCurrentJob()!=null)
        {
            map.addAttribute("currentJob",currentUser.getCurrentJob());
        }
        if(currentUser.getBirthday()!=null)
        {
            map.addAttribute("birthday", new SimpleDateFormat("dd/MM/yyyy").format(currentUser.getBirthday()));
        }
        if(currentUser.getEmail()!=null)
        {
            map.addAttribute("email", currentUser.getEmail());
            map.addAttribute("id", currentUser.getId());
        }
        if(currentUser.getSkills()!=null)
        {
            map.addAttribute("skills", currentUser.getSkills());
        }
        if(currentUser.getPhone()!=null)
        {
            map.addAttribute("phone", currentUser.getPhone());
        }
        if(currentUser.getDescription()!=null)
        {
            map.addAttribute("description", currentUser.getDescription());
        }
        if(currentUser.getImage()!=null)
        {
            map.addAttribute("image", Base64.getEncoder().encodeToString(currentUser.getImage().getData()));
        }
        if(currentUser.getName()!=null)
        {
            map.addAttribute("name", currentUser.getName());
        }
        if(currentUser.getAddress()!=null)
        {
            map.addAttribute("address",currentUser.getAddress());
        }
        Job currentJob = currentUser.getCurrentJob();
        if(currentJob!=null)
        {
            map.addAttribute("currentJob", currentJob);
            if(currentJob.getDatePosted()!=null)
            {
                map.addAttribute("startDate", new SimpleDateFormat("dd/MM/yyyy").format(currentJob.getDatePosted()));
            }
            map.addAttribute("employer", currentJob.getEmployerId());
        }

        return "profilePage";
    }

    @PostMapping("/viewProfilePage")
    public String viewProfilePage(String person)
    {
        return "redirect:/profilePage?person="+person.replace(" ","%20");
    }

    @GetMapping("/addCurrentJob")
    public String getAddCurrentJob(ModelMap map, Principal principal)
    {
        Person p = personService.findByEmail(principal.getName());
        if(p.getCurrentJob()!=null)
        {
            map.addAttribute("employer",p.getCurrentJob().getEmployerId());
            map.addAttribute("name", p.getCurrentJob().getName());
            map.addAttribute("experienceLevel", p.getCurrentJob().getExperienceLevel().name());
            map.addAttribute("location", p.getCurrentJob().getLocation());
            map.addAttribute("description", p.getCurrentJob().getDescription());
            Date startDate = p.getCurrentJob().getDatePosted();
            String formattedDate ="";
            if(startDate!=null)
            {
                formattedDate = new SimpleDateFormat("MM/dd/yyyy").format(startDate);
            }
            map.addAttribute("startDate", formattedDate);
        }
        return "addCurrentJob";
    }

    @PostMapping("addCurrentJ")
    public String addCurrentJob(String name, String experienceLevel,
                                String birthdayy, String employer, Principal principal, String location,
                                String description)
    {
        Person p = personService.findByEmail(principal.getName());
        Job j = p.getCurrentJob();
        if(j==null)
        {
            j = new Job();
        }
        //if(bindingResult.hasErrors())
//        {
//            return "/addCurrentJ";
//        }
        try {
            if(!birthdayy.equals(""))
            {
                j.setDatePosted(new SimpleDateFormat("yyyy-dd-MM").parse(birthdayy));
            }
        } catch (ParseException e) {
            e.printStackTrace();
        }
        if(!employer.equals(""))
        {
            j.setEmployerId(employer);
        }
        if(!name.equals(""))
        {
            j.setName(name);
        }
        j.setExperienceLevel(ExperienceLevel.valueOf(experienceLevel));

        if(!location.equals(""))
        {
            j.setLocation(location);
        }
        if(!description.equals(""))
        {
            j.setDescription(description);
        }
        personService.saveCurrentJob(p,j);
        return "redirect:/profilePage";
    }

    @PostMapping("/deletePersonSkill")
    public String deletePersonSkill(Principal principal, String name)
    {
        personService.removeSkill(principal.getName(),skillService.findByName(name));
        return "redirect:/addPersonSkill";
    }

    @GetMapping("/profileCompany")
    public String getProfilePageCompany(ModelMap map, Principal principal, String job)
    {
        Company currentUser =null;
        if(job==null)
        {
            String email = principal.getName();
            currentUser = companyService.findByEmail(email);
        }
        else
        {
            Job j = jobService.findById(job);
            currentUser = companyService.findById(j.getEmployerId());
            map.addAttribute("company",j.getEmployerId());
        }
        if(currentUser.getEmail()!=null)
        {
            map.addAttribute("email", currentUser.getEmail());
        }
        if(currentUser.getWebsite()!=null)
        {
            map.addAttribute("website", currentUser.getWebsite());
        }
        if(currentUser.getPhone()!=null)
        {
            map.addAttribute("phone", currentUser.getPhone());
        }
        if(currentUser.getImage()!=null)
        {
            map.addAttribute("image", Base64.getEncoder().encodeToString(currentUser.getImage().getData()));
        }
        if(currentUser.getName()!=null)
        {
            map.addAttribute("name", currentUser.getName());
        }
        List<Job> availableJobs = jobService.findByCompany(currentUser.getId());
        if(availableJobs!=null)
        {
            map.addAttribute("jobs", availableJobs.stream().limit(2).collect(Collectors.toList()));
        }

        Person manager = currentUser.getManager();
        if(manager!=null)
        {
            if(manager.getName()!=null)
            {
                map.addAttribute("nameM", manager.getName());
            }
            if(manager.getEmail()!=null)
            {
                map.addAttribute("emailM", manager.getEmail());
            }
            if(manager.getPhone()!=null)
            {
                map.addAttribute("phoneM",manager.getPhone());
            }
            if(manager.getAddress()!=null)
            {
                map.addAttribute("addressM",manager.getAddress());
            }
            if(manager.getDescription()!=null)
            {
                map.addAttribute("descriptionM", manager.getDescription());
            }
            if(manager.getImage()!=null)
            {
                map.addAttribute("imageM", Base64.getEncoder().encodeToString(manager.getImage().getData()));
            }
        }
        return "profileCompany";
    }

    @PostMapping("/viewProfilePageCompany")
    public String viewProfilePageCompany(String job)
    {
        return "redirect:/profileCompany?job="+job.replace(" ","%20");
    }

    @GetMapping("/viewPostedJobs")
    public String getViewPostedJobs(ModelMap map, Principal principal, String company)
    {
        List<Job> savedJobs = new ArrayList<>();
        //jobService.findAll().forEach((Job x) -> savedJobs.add(x));
        for(Job j : jobService.findAll())
        {
            savedJobs.add(j);
        }
        Company c;
        if(company!=null)
        {
            c = companyService.findById(company);
            Person ps = personService.findByEmail(principal.getName());
            List<Job> delJobs = new ArrayList<Job>();
            for(Job j : savedJobs){
                if(ps.getJobs()!=null)
                {
                    for(Job jb : ps.getJobs()){
                        if(jb.getId().equals(j.getId()))
                            delJobs.add(j);
                    }
                }
            }
            savedJobs.removeAll(delJobs);
        }
        else
        {
            c = companyService.findByEmail(principal.getName());
        }
        savedJobs = savedJobs.stream().filter(x -> x.getEmployerId().equals(c.getId())).collect(Collectors.toList());

        if(savedJobs!=null)
        {
            map.addAttribute("jobs", savedJobs);
        }
        if(c.getName()!=null)
        {
            map.addAttribute("name", c.getName());
        }

        List<String> images = new ArrayList<>();
        for(Job j : savedJobs)
        {
            if(c.getImage()!=null)
            {
                images.add(Base64.getEncoder().encodeToString(c.getImage().getData()));
            }
            else
            {
                images.add("");
            }
        }
        map.addAttribute("images", images);
        return "viewPostedJobs";
    }

    @GetMapping("/interestedPeople")
    public String getViewInterestedPeople(ModelMap map, Principal principal, String job)
    {
        List<Person> people = new ArrayList<>();
        personService.findAll().forEach(x -> people.add(x));
        List<Person> peopleInterested = new ArrayList<>();
        for(Person p : people){
            if(p.getJobs()!=null)
            {
                for(Job j : p.getJobs())
                    if (j.getId().equals(job))
                        peopleInterested.add(p);
            }
        }

        map.addAttribute("people", peopleInterested);

        List<String> images = new ArrayList<>();
        for(Person p : peopleInterested)
        {
            if(p.getImage()!=null)
            {
                images.add(Base64.getEncoder().encodeToString(p.getImage().getData()));
            }
            else
            {
                images.add("");
            }
        }
        map.addAttribute("images", images);
        map.addAttribute("jobId",job);
        map.addAttribute("job", jobService.findById(job));
        map.addAttribute("hiredPerson",jobService.findById(job).getHiredPerson());
        return "interestedPeople";
    }

    @PostMapping("/viewCV")
    public String viewCV(String id)
    {
        return "redirect:/viewCVPage?id="+id;
    }

    @GetMapping("/viewCVPage")
    public String getViewCV(String id, ModelMap map)
    {
        //img
        Person p = personService.findById(id);
        String img = new String("");
        //CV
        if(p.getCV()!=null)
        {
            img = Base64.getEncoder().encodeToString(p.getCV().getData());
        }

        map.addAttribute("image", img);
        map.addAttribute("id",id);
        return "viewCVPage";
    }

    @PostMapping("/addCV")
    public String addCV(@RequestParam("image") MultipartFile image, String id)
    {

        try {
            personService.updateCV(id, new Binary(BsonBinarySubType.BINARY, image.getBytes()));
        } catch (IOException e) {
            e.printStackTrace();
        }
        return "redirect:/viewCVPage?id="+id;
    }

    @PostMapping(path="/hirePerson")
    public String hirePerson(String job, String person){
        List<Person> allPersons = new ArrayList<Person>();
        personService.findAll().forEach(x->allPersons.add(x));

        Job jb = jobService.findById(job);
        //jb.notifyObservers();

        for(Person p : allPersons)
        {
            if(!p.getId().equals(person))
            {
                Job foundJob = null;
                if(p.getJobs()!=null)
                    for(Job j : p.getJobs())
                    {
                        if(j.getId().equals(job))
                            foundJob = j;
                    }
                if(foundJob!=null)
                    p.getJobs().remove(foundJob);
                //{}
                personService.updateJobs(p,p.getJobs());
            }
            else{
                    jb.setHiredPerson(person);
                    Job svdJob = null;
                    for(Job i : p.getJobs())
                        if(i.getId().equals(jb.getId()))
                            i.setHiredPerson(person);
                    personService.updateJobs(p,p.getJobs());
                    jobService.save(jb);
            }
        }

        return "redirect:/interestedPeople?job="+job;

    }

    @PostMapping(path="/viewInterestedPeople")
    public String viewInterestedPeople(String job)
    {
        return "redirect:/interestedPeople?job="+job.replace(" ", "%20");
    }

    @GetMapping("/browseJobs")
    public String getBrowseJobsPage(ModelMap map, Principal principal, HttpServletRequest request)
    {
        List<Job> allJobs = new ArrayList<>();
        Person p = personService.findByEmail(principal.getName());
        if(request.isUserInRole("PERSON"))
        {
            jobService.findAll().forEach(x -> {if(!p.interestedIn(x) && x.getHiredPerson() == null)
                        allJobs.add(x);
                    }
            );
        }
        else
        {
            //administrator
            jobService.findAll().forEach(x -> allJobs.add(x));

        }
        map.addAttribute("jobs", allJobs);

        List<Company> companies = new ArrayList<>();
        List<String> images = new ArrayList<>();
        for(Job j : allJobs)
        {
            Company c = companyService.findById(j.getEmployerId());
            companies.add(c);
            if(c.getImage()!=null)
            {
                images.add(Base64.getEncoder().encodeToString(c.getImage().getData()));
            }
            else {
                images.add("");
            }
        }
        map.addAttribute("companies", companies);
        map.addAttribute("images", images);
        return "browseJobs";
    }

    @PostMapping("/browseSearchResults")
    public String getSearchResults(String search, ModelMap map, Principal principal, String searchType,
                                   HttpServletRequest request)
    {
        User u = null;
        if(request.isUserInRole("PERSON") || request.isUserInRole("ADMIN"))
        {
            u = personService.findByEmail(principal.getName());
        }
        else if(request.isUserInRole("COMPANY"))
        {
            u = companyService.findByEmail(principal.getName());
        }
        List<Job> foundJobs = jobService.findJobs(u, search, searchType);

        if(foundJobs ==null)
        {
            if(searchType.equals("browse"))
            {
                return "redirect:/browseJobs";
            }
            else if(searchType.equals("saved"))
            {
                return "redirect:/savedJobs";
            }
            else if(searchType.equals("posted"))
            {
                return "redirect:/viewPostedJobs";
            }
            else if(searchType.equals("people"))
            {
                return "redirect:/interestedPeople";
            }
            else if(searchType.equals("users"))
            {
                return "redirect:/allusers";
            }
        }
        map.addAttribute("jobs", foundJobs);

        List<Company> companies = new ArrayList<>();
        List<String> images = new ArrayList<>();
        for(Job j : foundJobs)
        {
            Company c = companyService.findById(j.getEmployerId());
            companies.add(c);
            if(c.getImage()!=null)
            {
                images.add(Base64.getEncoder().encodeToString(c.getImage().getData()));
            }
            else
            {
                images.add("");
            }
        }
        map.addAttribute("companies", companies);
        map.addAttribute("images", images);

        if(searchType.equals("browse"))
        {
            return "browseJobs";
        }
        else if(searchType.equals("saved"))
        {
            return "savedJobs";
        }
        else
        {
            return "viewPostedJobs";
        }
    }

    @PostMapping("/browseSearchResults2")
    public String getSearchResults2(String search, ModelMap map, Principal principal, String searchType,
                                    HttpServletRequest request, String jobId)
    {
        List<Person> personList = null;
        List<Company> companies = null;

        if(request.isUserInRole("COMPANY"))
        {
            personList = personService.findPeople(search, searchType, jobId);

            if(personList ==null)
            {
                if(searchType.equals("people"))
                {
                    return "redirect:/interestedPeople?job="+jobId;
                }
            }
        }
        else if(request.isUserInRole("ADMIN"))
        {
            personList = personService.findPeople(search, searchType, null);
            companies = companyService.findCompanies(search,searchType);

            if(personList ==null && companies==null)
            {
                if(searchType.equals("users"))
                {
                    return "redirect:/allusers";
                }
            }
        }

        if(searchType.equals("people"))
        {
            map.addAttribute("people", personList);

            List<String> images = new ArrayList<>();
            for(Person p : personList)
            {
                if(p.getImage()!=null)
                {
                    images.add(Base64.getEncoder().encodeToString(p.getImage().getData()));
                }
                else
                {
                    images.add("");
                }
            }
            map.addAttribute("images", images);
            map.addAttribute("jobId",jobId);
            map.addAttribute("job", jobService.findById(jobId));
            map.addAttribute("hiredPerson",jobService.findById(jobId).getHiredPerson());
        }
        else if(searchType.equals("users"))
        {
            map.addAttribute("persons", personList);
            map.addAttribute("companies", companies);

            List<String> images = new ArrayList<>();
            for(Person p : personList)
            {
                if(p.getImage()!=null)
                {
                    images.add(Base64.getEncoder().encodeToString(p.getImage().getData()));
                }
                else
                {
                    images.add("");
                }
            }
            map.addAttribute("images", images);

            List<String> images2 = new ArrayList<>();
            for(Company c : companies)
            {
                if(c.getImage()!=null)
                {
                    images2.add(Base64.getEncoder().encodeToString(c.getImage().getData()));
                }
                else
                {
                    images2.add("");
                }
            }
            map.addAttribute("images2", images2);
        }

        if(searchType.equals("people"))
        {
            return "interestedPeople";
        }
        else
        {
            return "allUsers";
        }
    }

    @GetMapping("/savedJobs")
    public String getSavedJobsPage(ModelMap map, Principal principal)
    {
        Person p = personService.findByEmail(principal.getName());
        List<Job> savedJobs = p.getJobs();
        map.addAttribute("jobs", savedJobs);
        map.addAttribute("person", p.getId());

        List<Company> companies = new ArrayList<>();
        List<String> images = new ArrayList<>();
        if(savedJobs!=null)
        {
            for(Job j : savedJobs)
            {
                Company c = companyService.findById(j.getEmployerId());
                companies.add(c);
                if(c.getImage()!=null)
                {
                    images.add(Base64.getEncoder().encodeToString(c.getImage().getData()));
                }
            }
            map.addAttribute("companies", companies);
            map.addAttribute("images", images);
        }
        return "savedJobs";
    }

    @PostMapping(path="/saveJob")
    public String saveJob(String id, Principal principal)
    {
        personService.addJob(principal.getName(), jobService.findById(id));
        return "redirect:/savedJobs";
    }

    @GetMapping("/postjob")
    public String getAddJob()
    {
        return "postJob";
    }

    @PostMapping(path="/addj")
    public String addNewJob (Job j, BindingResult bindingResult, Principal principal, HttpServletRequest request) {
        if(bindingResult.hasErrors())
        {
            return "postJob";
        }
        String companyEmail = principal.getName();
        //SimpleDateFormat formatter = new SimpleDateFormat("hh:mm dd/MM/yyyy");
       // try {
            //j.setDatePosted(formatter.parse((new Date()).toString()));
        //}
        //p.setBirthday(new SimpleDateFormat("MM/dd/yyyy").parse(birthdayy));
        j.setDatePosted(new Date());
        Company c = companyService.findByEmail(companyEmail);
        j.setEmployerId(c.getId());
        jobService.save(j);
        if(request.isUserInRole("ADMIN"))
        {
            return "redirect:/browseJobs";
        }
        return "redirect:/addJobSkill?job="+j.getId().replace(" ", "%20");
    }

    @GetMapping(path="/addJobSkill")
    public String getAddSkillToJob(ModelMap map, String job)
    {
        List<String> allSkills = new ArrayList<String>();
        skillService.findAll().forEach(x -> allSkills.add(x.getName()));
        map.addAttribute("allSkills",allSkills);
        map.addAttribute("job",job);
        List<Skill> skills = new ArrayList<>();
        Job j = jobService.findById(job);
        if(j.getSkills()!=null)
        {
            j.getSkills().forEach(x->skills.add(x));
        }
        map.addAttribute("skills", skills);
        return "addJobSkill";
    }

    @PostMapping(path = "/skillsToJob")
    public String addSkillToJob(String name, String job)
    {
        Skill s = skillService.findByName(name);
        jobService.addSkill(job, s);
        return "redirect:/addJobSkill?job="+job.replace(" ", "%20");
    }

    @GetMapping("/addPersonSkill")
    public String getAddPersonSkillPage(ModelMap map, Principal principal)
    {
        String email = principal.getName();
        Person p = personService.findByEmail(email);
        if(p.getSkills()!=null)
        {
            map.addAttribute("skills",p.getSkills());
        }
        List<String> allSkills = new ArrayList<String>();
        skillService.findAll().forEach(x -> allSkills.add(x.getName()));
        map.addAttribute("allSkills",allSkills);
        return "addPersonSkill";
    }

    @PostMapping("/skillAdded")
    public String addSkill(Skill s, Principal principal)
    {
        s.setId(skillService.findByName(s.getName()).getId());
        String email = principal.getName();
        personService.addSkill(email,s);
        return "redirect:/addPersonSkill";
    }

    @GetMapping("/addperson")
    public String getAddPerson()
    {
        return "addPerson";
    }

    @PostMapping(path="/addp") // Map ONLY POST Requests
    public String addNewPerson (@RequestParam("image") MultipartFile image,String birthdayy, Person p, BindingResult bindingResult1,
                                String genderr, HttpServletRequest request) {
        if(bindingResult1.hasErrors() && !bindingResult1.hasFieldErrors("image"))
        {
            return "addPerson";
        }
        try {
            p.setImage(new Binary(BsonBinarySubType.BINARY, image.getBytes()));
        } catch (IOException e) {
            e.printStackTrace();
        }
        p.setGender(Gender.valueOf(genderr));
        try {
            p.setBirthday(new SimpleDateFormat("yyyy-dd-MM").parse(birthdayy));
        } catch (ParseException e) {
            e.printStackTrace();
        }
        personService.save(p);
        if(request.isUserInRole("ADMIN"))
        {
            return "redirect:/allusers";
        }
        return "redirect:/login";
    }

    @GetMapping("/editaccount")
    public String getEditAccount(ModelMap map, Principal principal, HttpServletRequest request)
    {
        User user = null;
        if(request.isUserInRole("PERSON") || request.isUserInRole("ADMIN"))
        {
            user = personService.findByEmail(principal.getName());
            if(((Person) user).getAddress()!=null)
            {
                map.addAttribute("address", ((Person) user).getAddress());
            }
        }
        else if(request.isUserInRole("COMPANY"))
        {
            user = companyService.findByEmail(principal.getName());
            if(((Company) user).getWebsite()!=null)
            {
                map.addAttribute("website", ((Company) user).getWebsite());
            }
        }
        if(user.getName()!=null)
        {
            map.addAttribute("name", user.getName());
        }
        if(user.getDescription()!=null)
        {
            map.addAttribute("description", user.getDescription());
        }
        if(user.getPhone()!=null)
        {
            map.addAttribute("phone", user.getPhone());
        }
        return "editAccount";
    }

    @PostMapping("/editAccount")
    public String editAccount(@RequestParam("image") MultipartFile image, HttpServletRequest request, Principal principal, String name, String email,
                              String description, String phone, String address)
    {
        if(request.isUserInRole("PERSON") || request.isUserInRole("ADMIN"))
        {
            Person p = personService.findByEmail(principal.getName());
            if(image.isEmpty())
            {
                personService.editPerson(p,null,name,description,phone,address);
            }
            else{
                try {
                    personService.editPerson(p,new Binary(BsonBinarySubType.BINARY, image.getBytes()),name
                            ,description,phone,address);
                } catch (IOException e) {
                    e.printStackTrace();
                }
            }
            return "redirect:/profilePage";
        }
        else if(request.isUserInRole("COMPANY"))
        {
            Company c = companyService.findByEmail(principal.getName());
            if(image.isEmpty())
            {
                companyService.editCompany(c,null,name,description,phone,address);
            }
            else{
                try {
                    companyService.editCompany(c,new Binary(BsonBinarySubType.BINARY, image.getBytes()),name,description,phone,address);
                } catch (IOException e) {
                    e.printStackTrace();
                }
            }
            return "redirect:/profileCompany";
        }
        return "editAccount";
    }

    @GetMapping("/changepassword")
    public String getChangePassword()
    {
        return "changePassword";
    }

    @PostMapping("/changePassword")
    public String changePassword(String password, String passwordNew1, String passwordNew2, Principal principal)
    {
        Person p = personService.findByEmail(principal.getName());
        if((new BCryptPasswordEncoder()).matches(password, p.getPassword())==false
            || passwordNew1.equals(passwordNew2)==false || password.equals(passwordNew1))
        {
            return "changePassword";
        }
        else
        {
            p.setPassword(passwordNew1);
            personService.save(p);
            return "redirect:/login";
        }
    }

    @GetMapping("/editManager")
    public String getEditManager(ModelMap map, Principal principal)
    {
        Company c = companyService.findByEmail(principal.getName());
        Person manager = c.getManager();
        if(manager!=null)
        {
            if(manager.getName()!=null)
            {
                map.addAttribute("name", manager.getName());
            }
            if(manager.getEmail()!=null)
            {
                map.addAttribute("email", manager.getEmail());
            }
            if(manager.getDescription()!=null)
            {
                map.addAttribute("description", manager.getDescription());
            }
            if(manager.getPhone()!=null)
            {
                map.addAttribute("phone", manager.getPhone());
            }
            if(manager.getAddress()!=null)
            {
                map.addAttribute("address", manager.getAddress());
            }
        }
        return "editManager";
    }

    @PostMapping("/editm")
    public String editManager(@RequestParam("image") MultipartFile image, String name, String email,
                              String description, String phone, String address, Principal principal)
    {
        Company c = companyService.findByEmail(principal.getName());
        Person manager = c.getManager();

        if(manager==null)
            manager = new Person();

        if(image.isEmpty())
        {
            companyService.editManager(c,manager,null,name,description,phone,address, email);
        }
        else{
            try {
                companyService.editManager(c,manager ,new Binary(BsonBinarySubType.BINARY, image.getBytes()),name
                        ,description,phone,address, email);
            } catch (IOException e) {
                e.printStackTrace();
            }
        }

        return "redirect:/profileCompany";
    }

    @GetMapping(path="/allusers")
    public String getAllPersons(ModelMap map) {
        // This returns a JSON or XML with the users
        List<Person> persons = new ArrayList<>();
        personService.findAll().forEach(x->persons.add(x));
        map.addAttribute("persons", persons);
        List<Company> companies = new ArrayList<>();
        companyService.findAll().forEach(x->companies.add(x));
        map.addAttribute("companies", companies);

        List<String> images = new ArrayList<>();
        for(Person p : persons)
        {
            if(p.getImage()!=null)
            {
                images.add(Base64.getEncoder().encodeToString(p.getImage().getData()));
            }
        }
        map.addAttribute("images", images);

        List<String> images2 = new ArrayList<>();
        for(Company c : companies)
        {
            if(c.getImage()!=null)
            {
                images2.add(Base64.getEncoder().encodeToString(c.getImage().getData()));
            }
        }
        map.addAttribute("images2", images2);
        return "allUsers";
    }

    @GetMapping("/addskill")
    public String getAddSkill(ModelMap map)
    {
        List<Skill> skills = new ArrayList<>();
        skillService.findAll().forEach(x->skills.add(x));
        map.addAttribute("skills", skills);
        return "addSkill";
    }

    @PostMapping(path="/adds")
    public String addNewSkill (String name) {
        // @ResponseBody means the returned String is the response, not a view name
        // @RequestParam means it is a parameter from the GET or POST request

        Skill s = new Skill();
        s.setName(name);
        skillService.save(s);
        return "redirect:/addskill";
    }

    @PostMapping("/deleteSkill")
    public String deleteSkillAdmin (String name)
    {
        skillService.removeSkill(name);
        return "redirect:/addskill";
    }

    @PostMapping("/deleteJobSkill")
    public String deleteJobSkill (String name, String job)
    {
        Job j = jobService.findById(job);
        jobService.removeSkill(name, j);
        return "redirect:/addJobSkill?job="+job;
    }

    @PostMapping("/deleteJob")
    public String deleteJob(String id, HttpServletRequest request)
    {
        jobService.removeJob(id);
        if(request.isUserInRole("ADMIN"))
        {
            return "redirect:/browseJobs";
        }
        else
        {
            return "redirect:/viewPostedJobs";
        }
    }

    @PostMapping("/editJob")
    public String editJob(String job, HttpServletRequest request)
    {
        return "redirect:/editjob?job="+job.replace(" ", "%20");
    }

    @GetMapping("/editjob")
    public String getEditJob(String job, ModelMap map)
    {
        map.addAttribute("job", job);
        Job j = jobService.findById(job);
        if(j.getName()!=null)
        {
            map.addAttribute("name", j.getName());
        }
        if(j.getExperienceLevel()!=null)
        {
            map.addAttribute("experienceLevel", j.getExperienceLevel().name());
        }
        if(j.getDescription()!=null)
        {
            map.addAttribute("description", j.getDescription());
        }
        if(j.getLocation()!=null)
        {
            map.addAttribute("location", j.getLocation());
        }
        if(j.getIndustry()!=null)
        {
            map.addAttribute("industry", j.getIndustry());
        }
        return "editJob";
    }

    @PostMapping("/editj")
    public String editJobDetails(String job, String name, String experienceLevel, String description,
                                 String location, String industry)
    {
        jobService.editJob(job, name, experienceLevel, location, industry, description);
        return "redirect:/addJobSkill?job="+job.replace(" ", "%20");
    }

    @GetMapping(path="/allskills")
    public String getAllSkills(ModelMap map) {
        // This returns a JSON or XML with the skills
        map.addAttribute("skills", skillService.findAll());
        return "redirect:/addskill";
    }

    @GetMapping("/addcompany")
    public String getAddCompany() {return "addCompany";}

    @PostMapping(path="/addc")
    public String addNewCompany (@RequestParam("image") MultipartFile image, Company c,
                                 BindingResult bindingResult, HttpServletRequest request) {
        if(bindingResult.hasErrors() && !bindingResult.hasFieldErrors("image"))
        {
            return "addCompany";
        }
        try {
            c.setImage(new Binary(BsonBinarySubType.BINARY, image.getBytes()));
        } catch (IOException e) {
            e.printStackTrace();
        }
        companyService.save(c);
        if(request.isUserInRole("ADMIN"))
        {
            return "redirect:/allusers";
        }
        return "redirect:/login";
    }

    @PostMapping("/deleteUser")
    public String deleteSkill (String id)
    {
        User u = personService.findById(id);
        if(u == null)
        {
            u = companyService.findById(id);
            companyService.removeCompany((Company) u);
        }
        else {
            personService.removePerson((Person) u);
        }
        return "redirect:/allusers";
    }
}
